# Main Nginx configuration
worker_processes auto;
pid /tmp/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include mime.types;
    default_type application/octet-stream;
    sendfile on;
    keepalive_timeout 65;

    # Server block
    server {
        listen ${PORT};
        server_name cst5l-bitforge-backend-production.up.railway.app;
        root /app/public;

        # Security headers
        add_header X-Frame-Options "SAMEORIGIN";
        add_header X-Content-Type-Options "nosniff";
        add_header Referrer-Policy "strict-origin-when-cross-origin";

        # CORS headers
        add_header Access-Control-Allow-Origin "https://cst5l-bitforge-frontend-production.up.railway.app" always;
        add_header Access-Control-Allow-Credentials "true" always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With" always;

        index index.php;

        charset utf-8;

        # Handle static files
        location / {
            try_files $uri $uri/ /index.php?$query_string;
        }

        location = /favicon.ico { 
          access_log off; 
          log_not_found off; 
        }
        
        location = /robots.txt  { 
          access_log off; 
          log_not_found off; 
        }

        error_page 404 /index.php;
        error_page 500 502 503 504 /index.php;

        location ~ \.php$ {
            fastcgi_pass unix:/var/run/php/php-fpm.sock;
            fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
            include fastcgi_params;
            fastcgi_param HTTP_PROXY "";
            fastcgi_read_timeout 300;
        }

        location ~ /\.(?!well-known).* {
            deny all;
        }

        # CORS preflight requests
        if ($request_method = OPTIONS) {
            add_header Access-Control-Allow-Origin "https://cst5l-bitforge-frontend-production.up.railway.app";
            add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS";
            add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With";
            add_header Access-Control-Allow-Credentials "true";
            add_header Content-Length 0;
            add_header Content-Type "text/plain; charset=UTF-8";
            return 204;
        }
    }
}